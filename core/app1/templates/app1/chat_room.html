{% extends 'app1/base.html' %}

{% block title %}{{ room.name|default:"Chat" }} - WhatsApp Clone{% endblock %}

{% block extra_css %}
<style>
    /* Disable page scrolling */
    body {
        overflow: hidden;
        height: 100vh;
    }
    
    .chat-container {
        height: calc(100vh - 64px);
        max-height: calc(100vh - 64px);
        overflow: hidden;
        position: relative;
        width: 100%;
        margin: 0;
        padding: 0;
    }
    .main-chat-area {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }
    #messages-container {
        flex: 1 1 auto;
        overflow-y: auto !important;
        overflow-x: hidden;
        min-height: 0;
        max-height: 100%;
    }
    .message-bubble {
        max-width: 70%;
        word-wrap: break-word;
    }
    .typing-indicator {
        animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    /* Custom scrollbar for messages area */
    #messages-container::-webkit-scrollbar {
        width: 6px;
    }
    #messages-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    #messages-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    #messages-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    /* Custom scrollbar for participants list */
    .participants-list::-webkit-scrollbar {
        width: 6px;
    }
    .participants-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    .participants-list::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    .participants-list::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    /* Notification toast (Windows 11 style) */
    .notification-toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        min-width: 320px;
        max-width: 400px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.3s ease-out, slideOutRight 0.3s ease-out 2.7s;
        z-index: 1000;
        border-left: 4px solid #0078d4;
    }
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    /* Fix message input at bottom */
    .message-input-container {
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 1px solid #e5e7eb;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden h-full">
        <div class="flex h-full" style="height: 100%;">
            <!-- Sidebar -->
            <div class="w-1/3 bg-gray-50 border-r border-gray-200 flex flex-col">
                <!-- Header -->
                <div class="p-4 bg-white border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-800">Participants</h2>
                        <div class="flex space-x-2">
                            <a href="{% url 'create_group_chat' %}" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </a>
                            <a href="{% url 'search_users' %}" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">{{ room.participants.count }} member{{ room.participants.count|pluralize }}</p>
                </div>

                <!-- Participants List -->
                <div class="flex-1 overflow-y-auto participants-list">
                    <a href="{% url 'chat_list' %}" class="block p-4 hover:bg-gray-100 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-sm font-medium text-gray-900">Back to Chats</h3>
                                <p class="text-xs text-gray-500">Return to chat list</p>
                            </div>
                        </div>
                    </a>

                    <!-- Participants -->
                    {% for participant in room.participants.all %}
                        <div class="flex items-center p-4 hover:bg-gray-100 border-b border-gray-200">
                            <div class="relative">
                                {% if participant.profile_picture %}
                                    <img src="{{ participant.profile_picture.url }}" alt="{{ participant.username }}" class="w-12 h-12 rounded-full object-cover">
                                {% else %}
                                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold text-lg">
                                        {{ participant.username|first|upper }}
                                    </div>
                                {% endif %}
                                <!-- Online Status Indicator -->
                                {% if participant.is_online %}
                                    <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
                                {% else %}
                                    <div class="absolute bottom-0 right-0 w-4 h-4 bg-gray-400 border-2 border-white rounded-full"></div>
                                {% endif %}
                            </div>
                            <div class="ml-4 flex-1">
                                <h3 class="font-medium text-gray-900">
                                    {{ participant.username }}
                                    {% if participant == user %}
                                        <span class="text-blue-600 text-sm">(You)</span>
                                    {% endif %}
                                </h3>
                                <p class="text-sm text-gray-500">
                                    {% if participant.is_online %}
                                        <span class="text-green-600">Online</span>
                                    {% else %}
                                        Last seen {{ participant.last_seen|timesince }} ago
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="flex-1 flex flex-col main-chat-area">
                <!-- Chat Header -->
                <div class="p-4 bg-white border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                        <div class="relative">
                            {% if room.room_type == 'direct' %}
                                {% for participant in other_participants %}
                                    {% if participant.profile_picture %}
                                        <img src="{{ participant.profile_picture.url }}" alt="{{ participant.username }}" class="w-10 h-10 rounded-full object-cover">
                                    {% else %}
                                        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold">
                                            {{ participant.username|first|upper }}
                                        </div>
                                    {% endif %}
                                    {% if participant.is_online %}
                                        <div class="online-indicator"></div>
                                    {% else %}
                                        <div class="offline-indicator"></div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                                    {{ room.name|first|upper }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900">
                                {% if room.room_type == 'direct' %}
                                    {% for participant in other_participants %}{{ participant.username }}{% endfor %}
                                {% else %}
                                    {{ room.name }}
                                {% endif %}
                            </h3>
                            <p class="text-sm text-gray-500">
                                {% if room.room_type == 'direct' %}
                                    {% for participant in other_participants %}
                                        {% if participant.is_online %}Online{% else %}Last seen {{ participant.last_seen|timesince }} ago{% endif %}
                                    {% endfor %}
                                {% else %}
                                    {{ room.participants.count }} members
                                {% endif %}
                            </p>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <!-- Connection Status -->
                            <div id="connection-status" class="flex items-center space-x-1">
                                <div id="status-indicator" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                <span id="status-text" class="text-xs text-gray-500">Connecting...</span>
                            </div>
                            
                            <button class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                            <button class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                    {% for message in messages %}
                    <div class="flex {% if message.sender == user %}justify-end{% else %}justify-start{% endif %}">
                        <div class="message-bubble {% if message.sender == user %}bg-green-500 text-white{% else %}bg-white text-gray-900{% endif %} rounded-lg p-3 shadow-sm">
                            {% if message.reply_to %}
                            <div class="border-l-4 border-gray-300 pl-2 mb-2 text-sm opacity-75">
                                <p class="font-medium">{{ message.reply_to.sender.username }}</p>
                                <p>{{ message.reply_to.content|truncatechars:50 }}</p>
                            </div>
                            {% endif %}
                            
                            {% if message.message_type == 'image' %}
                                {% if message.media_file %}
                                    <img src="{{ message.media_file.url }}" alt="Image" class="max-w-xs rounded">
                                {% endif %}
                            {% elif message.message_type == 'video' %}
                                {% if message.media_file %}
                                    <video controls class="max-w-xs rounded">
                                        <source src="{{ message.media_file.url }}" type="video/mp4">
                                    </video>
                                {% endif %}
                            {% else %}
                                <p>{{ message.content }}</p>
                            {% endif %}
                            
                            <div class="flex items-center justify-between mt-1 text-xs opacity-75">
                                <span>{{ message.timestamp|time }}</span>
                                {% if message.sender == user %}
                                    <span>
                                        {% if message.is_read %}✓✓{% else %}✓{% endif %}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-gray-500 mt-8">
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Typing Indicator -->
                <div id="typing-indicator" class="px-4 py-2 hidden">
                    <div class="flex items-center space-x-2 text-gray-500">
                        <div class="typing-indicator flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        </div>
                        <span class="text-sm" id="typing-text">Someone is typing...</span>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="message-input-container p-4 bg-white border-t border-gray-200">
                    <form id="message-form" class="flex items-center space-x-2">
                        {% csrf_token %}
                        <input type="hidden" id="room-id" value="{{ room.id }}">
                        
                        <button type="button" id="attach-btn" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                            </svg>
                        </button>
                        
                        <input type="file" id="file-input" accept="image/*,video/*" class="hidden">
                        
                        <div class="flex-1 relative">
                            <input type="text" id="message-input" placeholder="Type a message..." 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>
                        
                        <button type="submit" class="p-2 text-white bg-green-500 hover:bg-green-600 rounded-full">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Toast Container -->
<div id="notification-container"></div>

<script>
const roomId = document.getElementById('room-id').value;
const messagesContainer = document.getElementById('messages-container');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const fileInput = document.getElementById('file-input');
const attachBtn = document.getElementById('attach-btn');
const typingIndicator = document.getElementById('typing-indicator');
const typingText = document.getElementById('typing-text');
const statusIndicator = document.getElementById('status-indicator');
const statusText = document.getElementById('status-text');

// WebSocket connection
let chatSocket;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/${roomId}/`;
    
    console.log('Connecting to WebSocket:', wsUrl);
    
    chatSocket = new WebSocket(wsUrl);

    chatSocket.onopen = function(e) {
        console.log('WebSocket connection opened');
        reconnectAttempts = 0;
        statusIndicator.className = 'w-2 h-2 bg-green-500 rounded-full';
        statusText.textContent = 'Connected';
    };

    chatSocket.onmessage = function(e) {
        console.log('WebSocket message received:', e.data);
        const data = JSON.parse(e.data);
        
        if (data.type === 'chat_message') {
            addMessage(data.message);
        } else if (data.type === 'typing_indicator') {
            handleTypingIndicator(data);
        } else if (data.type === 'user_status') {
            handleUserStatus(data);
        }
    };

    chatSocket.onclose = function(e) {
        console.log('WebSocket connection closed:', e.code, e.reason);
        statusIndicator.className = 'w-2 h-2 bg-red-500 rounded-full';
        statusText.textContent = 'Disconnected';
        
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`);
            statusText.textContent = `Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`;
            setTimeout(connectWebSocket, 2000 * reconnectAttempts);
        } else {
            console.error('Max reconnection attempts reached');
            statusText.textContent = 'Connection failed';
            alert('Connection lost. Please refresh the page.');
        }
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket error:', e);
        statusIndicator.className = 'w-2 h-2 bg-red-500 rounded-full';
        statusText.textContent = 'Error';
    };
}

// Initialize WebSocket connection
connectWebSocket();

// Message handling
function addMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex ${message.sender.id === '{{ user.id }}' ? 'justify-end' : 'justify-start'}`;
    
    const bubbleClass = message.sender.id === '{{ user.id }}' ? 
        'bg-green-500 text-white' : 'bg-white text-gray-900';
    
    let content = '';
    if (message.message_type === 'image') {
        content = `<img src="${message.media_file}" alt="Image" class="max-w-xs rounded">`;
    } else if (message.message_type === 'video') {
        content = `<video controls class="max-w-xs rounded"><source src="${message.media_file}" type="video/mp4"></video>`;
    } else {
        content = `<p>${message.content}</p>`;
    }
    
    messageDiv.innerHTML = `
        <div class="message-bubble ${bubbleClass} rounded-lg p-3 shadow-sm">
            ${content}
            <div class="flex items-center justify-between mt-1 text-xs opacity-75">
                <span>${new Date(message.timestamp).toLocaleTimeString()}</span>
                ${message.sender.id === '{{ user.id }}' ? 
                    `<span>${message.is_read ? '✓✓' : '✓'}</span>` : ''}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    
    // Scroll to bottom after a small delay to ensure DOM updates
    setTimeout(() => {
        scrollToBottom();
    }, 100);
    
    // Show notification if message is not from current user
    if (message.sender.id !== '{{ user.id|stringformat:"s" }}') {
        showNotification(
            message.sender.username,
            message.content || 'Sent an attachment',
            message.sender.username
        );
    }
}

function handleTypingIndicator(data) {
    if (data.is_typing) {
        typingText.textContent = `${data.username} is typing...`;
        typingIndicator.classList.remove('hidden');
    } else {
        typingIndicator.classList.add('hidden');
    }
}

function handleUserStatus(data) {
    // Update online status indicators
    console.log(`${data.username} is ${data.is_online ? 'online' : 'offline'}`);
}

// Function to scroll to bottom of messages
function scrollToBottom() {
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Function to show notification toast (Windows 11 style)
function showNotification(title, message, senderName = '') {
    const container = document.getElementById('notification-container');
    const toastId = 'toast-' + Date.now();
    
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = 'notification-toast';
    toast.innerHTML = `
        <div class="flex-shrink-0">
            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold">
                ${senderName ? senderName.charAt(0).toUpperCase() : 'N'}
            </div>
        </div>
        <div class="flex-1 min-w-0">
            <h4 class="font-semibold text-gray-900 text-sm truncate">${title}</h4>
            <p class="text-sm text-gray-600 truncate">${message}</p>
        </div>
    `;
    
    container.appendChild(toast);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
            toastElement.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                toastElement.remove();
            }, 300);
        }
    }, 3000);
}

// Auto-scroll to bottom on page load
window.addEventListener('load', function() {
    setTimeout(() => {
        scrollToBottom();
    }, 300);
});

// Also try on DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        scrollToBottom();
    }, 300);
});

// Form submission
messageForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        console.log('Sending message:', message);
        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'content': message,
            'message_type': 'text'
        }));
        messageInput.value = '';
    } else if (!message) {
        console.log('No message to send');
    } else {
        console.error('WebSocket not ready:', chatSocket ? chatSocket.readyState : 'not connected');
    }
});

// Typing indicators
let typingTimer;
messageInput.addEventListener('input', function() {
    if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            'type': 'typing'
        }));
        
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'type': 'stop_typing'
                }));
            }
        }, 1000);
    }
});

// File upload
attachBtn.addEventListener('click', function() {
    fileInput.click();
});

fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/upload-media/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                chatSocket.send(JSON.stringify({
                    'type': 'chat_message',
                    'content': '',
                    'message_type': file.type.startsWith('image/') ? 'image' : 'video',
                    'media_file': data.file_url
                }));
            }
        });
    }
});

// Auto-scroll to bottom
messagesContainer.scrollTop = messagesContainer.scrollHeight;
</script>
{% endblock %}
