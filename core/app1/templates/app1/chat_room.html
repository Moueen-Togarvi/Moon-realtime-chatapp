{% extends 'app1/base.html' %}

{% block title %}{{ room.name|default:"Chat" }} - WhatsApp Clone{% endblock %}

{% block extra_css %}
<style>
    /* Disable page scrolling */
    body {
        overflow: hidden;
        height: 100vh;
    }

    /* Charcoal Palette */
    :root {
        --sent-bubble-bg: #424242;
        /* Lighter charcoal for sent */
        --sent-bubble-text: #ffffff;
        --received-bubble-bg: #303030;
        /* Medium charcoal for received */
        --received-bubble-text: #ffffff;
        --input-bg: #2a2a2a;
        /* Slightly lighter than main bg */
        --border-color: rgba(255, 255, 255, 0.08);
    }

    body {
        margin: 0;
        padding: 0;
        overflow: hidden !important;
        height: 100vh !important;
        background: #212121;
        /* Main Background */
    }

    .chat-container {
        display: flex;
        height: 100vh !important;
        width: 100%;
        overflow: hidden;
    }

    #messages-container {
        flex: 1;
        min-height: 0;
        overflow-y: auto !important;
        overflow-x: hidden;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: #212121;
    }

    .message-bubble {
        max-width: 75%;
        padding: 12px 18px;
        font-size: 0.95rem;
        line-height: 1.6;
        position: relative;
    }

    /* Sender (You) - Lighter Charcoal */
    .message-sender {
        align-self: flex-end;
        background: var(--sent-bubble-bg);
        color: var(--sent-bubble-text);
        border-radius: 20px 20px 2px 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    /* Receiver - Medium Charcoal */
    .message-receiver {
        align-self: flex-start;
        background: var(--received-bubble-bg);
        color: var(--received-bubble-text);
        border-radius: 20px 20px 20px 2px;
        border: 1px solid var(--border-color);
    }

    .message-input-container {
        background: #212121;
        border-top: 1px solid var(--border-color);
        padding: 20px 24px;
        z-index: 10;
        flex-shrink: 0;
    }

    .input-pill {
        background: var(--input-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 30px;
        padding: 4px 8px 4px 24px;
        transition: all 0.3s ease;
    }

    .input-pill:focus-within {
        border-color: #616161;
        background: #333333;
    }

    #message-input {
        background: transparent !important;
        border: none !important;
        color: #ffffff !important;
        padding: 10px 0;
        font-size: 1rem;
        box-shadow: none !important;
    }

    #message-input:focus {
        outline: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container h-full overflow-hidden">
    <div class="flex h-full w-full">
        <!-- Sidebar: Chat List -->
        {% include 'app1/_chat_sidebar.html' %}

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col h-full main-chat-area bg-[#212121]">
            <!-- Chat Header -->
            <div class="flex-shrink-0 p-6 bg-[#212121] border-b border-white/10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4 w-full">
                        <div class="relative">
                            {% if room.room_type == 'direct' %}
                            {% for participant in other_participants %}
                            {% if participant.username == 'AI_Assistant' %}
                            <div
                                class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-black font-bold text-xl shadow-[0_0_15px_rgba(255,255,255,0.2)]">
                                AI
                            </div>
                            <div
                                class="absolute bottom-0 right-0 w-3 h-3 bg-white border-2 border-black rounded-full shadow-[0_0_10px_#fff]">
                            </div>
                            {% else %}
                            <div
                                class="w-12 h-12 bg-zinc-900 rounded-full flex items-center justify-center text-white font-bold text-xl overflow-hidden border border-white/10">
                                {% if participant.profile_picture %}
                                <img src="{{ participant.profile_picture.url }}" alt="{{ participant.username }}"
                                    class="w-full h-full object-cover grayscale">
                                {% else %}
                                {{ participant.username|first|upper }}
                                {% endif %}
                            </div>
                            {% if participant.is_online %}
                            <div
                                class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-white border-2 border-black rounded-full shadow-[0_0_10px_#fff]">
                            </div>
                            {% else %}
                            <div
                                class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-zinc-800 border-2 border-black rounded-full">
                            </div>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                            {% else %}
                            <div
                                class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-black font-bold text-xl shadow-[0_0_15px_rgba(255,255,255,0.2)]">
                                {{ room.name|first|upper }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white tracking-tight">
                                {% if room.room_type == 'direct' %}
                                {% for participant in other_participants %}
                                {% if participant.username == 'AI_Assistant' %}
                                AI Assistant
                                {% else %}
                                {{ participant.username }}
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                {{ room.name }}
                                {% endif %}
                            </h3>
                            <p class="text-[10px] text-zinc-500 uppercase tracking-[0.2em] mt-1 font-bold">
                                {% if room.room_type == 'direct' %}
                                {% for participant in other_participants %}
                                {% if participant.username == 'AI_Assistant' %}
                                Neural Processor Active
                                {% elif participant.is_online %}
                                Frequency Sync Locked
                                {% else %}
                                Transmission Offline
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                {{ room.participants.count }} Terminals
                                {% endif %}
                            </p>
                        </div>

                        <div class="flex items-center space-x-2">
                            <div id="connection-status" class="flex items-center space-x-2 mr-6">
                                <div id="status-indicator" class="w-1.5 h-1.5 bg-zinc-700 rounded-full"></div>
                                <span id="status-text"
                                    class="text-[10px] uppercase tracking-widest text-zinc-600 font-bold">Sync</span>
                            </div>

                            <button class="p-2 text-zinc-500 hover:text-white transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                    </path>
                                </svg>
                            </button>
                            <button class="p-2 text-zinc-500 hover:text-white transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messages-container">
                {% for message in messages %}
                <div
                    class="message-bubble {% if message.sender == user %}message-sender{% else %}message-receiver{% endif %}">
                    {% if message.reply_to %}
                    <div
                        class="border-l-2 {% if message.sender == user %}border-black/20{% else %}border-white/20{% endif %} pl-3 mb-3 text-[10px] uppercase font-bold opacity-60">
                        <p>{{ message.reply_to.sender.username }}</p>
                        <p class="font-medium normal-case">{{ message.reply_to.content|truncatechars:40 }}</p>
                    </div>
                    {% endif %}

                    {% if message.message_type == 'image' %}
                    {% if message.media_file %}
                    <img src="{{ message.media_file.url }}" alt="Image"
                        class="max-w-xs rounded-lg grayscale hover:grayscale-0 transition-all duration-700">
                    {% endif %}
                    {% elif message.message_type == 'video' %}
                    {% if message.media_file %}
                    <video controls class="max-w-xs rounded-lg grayscale">
                        <source src="{{ message.media_file.url }}" type="video/mp4">
                    </video>
                    {% endif %}
                    {% else %}
                    <p>{{ message.content }}</p>
                    {% endif %}

                    <div
                        class="flex items-center justify-end mt-2 text-[9px] uppercase tracking-widest font-bold opacity-50">
                        <span>{{ message.timestamp|time }}</span>
                        {% if message.sender == user %}
                        <span class="ml-2">{% if message.is_read %}//{% else %}/{% endif %}</span>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="flex-1 flex items-center justify-center opacity-20">
                    <div class="text-center">
                        <p class="text-white text-[10px] uppercase tracking-[0.5em]">System Ready</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="px-8 py-3 hidden">
                <div class="flex items-center space-x-3">
                    <div class="flex space-x-1.5">
                        <div class="w-1 h-1 bg-white rounded-full animate-ping"></div>
                        <div class="w-1 h-1 bg-white rounded-full animate-ping [animation-delay:-0.2s]"></div>
                        <div class="w-1 h-1 bg-white rounded-full animate-ping [animation-delay:-0.4s]"></div>
                    </div>
                    <span class="text-[9px] uppercase tracking-[0.2em] text-zinc-500 font-bold" id="typing-text">Input
                        Detected</span>
                </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
                <form id="message-form" class="flex items-center space-x-4">
                    {% csrf_token %}
                    <input type="hidden" id="room-id" value="{{ room.id }}">

                    <button type="button" id="attach-btn"
                        class="p-2 text-zinc-500 hover:text-white transition-all transform hover:scale-110">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                            </path>
                        </svg>
                    </button>

                    <input type="file" id="file-input" accept="image/*,video/*" class="hidden">

                    <div class="flex-1 input-pill flex items-center">
                        <input type="text" id="message-input" placeholder="Transmission..." autocomplete="off"
                            class="flex-1">

                        {% if is_ai_room %}
                        <button type="button" id="ask-ai"
                            class="mr-2 px-4 py-1.5 text-[10px] font-black uppercase tracking-widest text-black bg-white rounded-full hover:bg-zinc-200 transition-all transform active:scale-95 shadow-[0_0_10px_rgba(255,255,255,0.3)]">AI</button>
                        {% endif %}
                    </div>

                    <button type="submit" id="send-btn"
                        class="w-12 h-12 flex items-center justify-center text-black bg-white rounded-full hover:bg-zinc-200 transition-all transform hover:scale-105 active:scale-90 shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="notification-container"></div>

<script>
    const roomId = document.getElementById('room-id').value;
    const currentUserId = '{{ user.id|stringformat:"s" }}';
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');
    const attachBtn = document.getElementById('attach-btn');
    const typingIndicator = document.getElementById('typing-indicator');
    const typingText = document.getElementById('typing-text');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const askAiBtn = document.getElementById('ask-ai');

    let chatSocket;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${roomId}/`;

        console.log("Attempting WebSocket connection...");
        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function (e) {
            console.log("WebSocket connected.");
            reconnectAttempts = 0;
            statusIndicator.className = 'w-1.5 h-1.5 bg-white rounded-full shadow-[0_0_8px_#fff]';
            statusText.textContent = 'ONLINE';
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            if (data.type === 'chat_message') {
                console.timeEnd('message-latency');
                console.log("Processing chat message:", data);

                // If this is our own message, it might already be in the UI (optimistic)
                // We should update it or ensure no duplicates
                const existingOptimistic = document.querySelector(`[data-temp-id="${data.message.temp_id}"]`);
                if (existingOptimistic) {
                    existingOptimistic.removeAttribute('data-temp-id');
                    existingOptimistic.style.opacity = '1';
                    // Update timestamp or status if needed
                } else {
                    addMessage(data.message);
                }

                if (data.message.sender.id !== currentUserId) {
                    chatSocket.send(JSON.stringify({ 'type': 'message_read', 'message_id': data.message.id }));
                }
            } else if (data.type === 'typing_indicator') {
                handleTypingIndicator(data);
            }
        };

        chatSocket.onclose = function (e) {
            console.log("WebSocket closed. Reason:", e.reason);
            statusIndicator.className = 'w-1.5 h-1.5 bg-zinc-700 rounded-full';
            statusText.textContent = 'OFFLINE';

            // Exponential backoff
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Reconnecting in ${delay}ms (Attempt ${reconnectAttempts})...`);
                setTimeout(connectWebSocket, delay);
            }
        };

        chatSocket.onerror = function (err) {
            console.error("WebSocket Error:", err);
            chatSocket.close();
        };
    }

    connectWebSocket();

    function addMessage(message) {
        const messageDiv = document.createElement('div');
        const isMe = message.sender.id === currentUserId || message.is_optimistic;
        messageDiv.className = `message-bubble ${isMe ? 'message-sender' : 'message-receiver'}`;

        let content = '';
        if (message.message_type === 'image') {
            content = `<img src="${message.media_file}" alt="Image" class="max-w-xs rounded-lg grayscale hover:grayscale-0 transition-all duration-700">`;
        } else if (message.message_type === 'video') {
            content = `<video controls class="max-w-xs rounded-lg grayscale"><source src="${message.media_file}" type="video/mp4"></video>`;
        } else {
            content = `<p>${message.content}</p>`;
        }

        messageDiv.innerHTML = `
            ${message.reply_to ? `<div class="border-l-2 ${isMe ? 'border-black/20' : 'border-white/20'} pl-3 mb-3 text-[10px] uppercase font-bold opacity-60"><p>${message.reply_to.sender.username}</p><p class="font-medium normal-case">${message.reply_to.content.substring(0, 40)}...</p></div>` : ''}
            ${content}
            <div class="flex items-center justify-end mt-2 text-[9px] uppercase tracking-widest font-bold opacity-50">
                <span>${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                ${isMe ? `<span class="ml-2">${message.is_read ? '//' : '/'}</span>` : ''}
            </div>
        `;

        messagesContainer.appendChild(messageDiv);
        scrollToBottom();

        if (!isMe && !message.is_optimistic) {
            showNotification(message.sender.username, message.content || 'Transmission received', message.sender.username);
        }
        return messageDiv;
    }

    function handleTypingIndicator(data) {
        if (data.is_typing) {
            typingText.textContent = `${data.username.toUpperCase()} TRANSMITTING...`;
            typingIndicator.classList.remove('hidden');
        } else {
            typingIndicator.classList.add('hidden');
        }
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showNotification(title, message, senderName = '') {
        const container = document.getElementById('notification-container');
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-white text-black p-4 rounded-lg shadow-2xl z-50 transition-all border border-black max-w-sm';
        toast.innerHTML = `<h4 class="font-black uppercase text-xs tracking-widest border-b border-black/10 pb-1 mb-1">${title}</h4><p class="text-xs font-bold leading-tight">${message}</p>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    messageForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (content && chatSocket.readyState === WebSocket.OPEN) {
            const tempId = Date.now().toString();

            // Optimistic UI update
            const optimisticMessage = {
                content: content,
                sender: { id: currentUserId, username: 'You' },
                timestamp: new Date().toISOString(),
                message_type: 'text',
                is_optimistic: true,
                temp_id: tempId
            };

            const msgDiv = addMessage(optimisticMessage);
            msgDiv.setAttribute('data-temp-id', tempId);
            msgDiv.style.opacity = '0.7'; // Indicate send-in-progress

            console.time('message-latency');
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'content': content,
                'message_type': 'text',
                'temp_id': tempId
            }));

            messageInput.value = '';
        }
    });

    attachBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('file', file);
            fetch('/upload-media/', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        chatSocket.send(JSON.stringify({
                            'type': 'chat_message',
                            'content': '',
                            'message_type': file.type.startsWith('image/') ? 'image' : 'video',
                            'media_file': data.file_url
                        }));
                    }
                });
        }
    });

    if (askAiBtn) {
        askAiBtn.addEventListener('click', function () {
            const text = messageInput.value.trim();
            if (text && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({ 'type': 'chat_message', 'content': text, 'message_type': 'text' }));
                messageInput.value = '';
                askAiBtn.disabled = true;
                setTimeout(() => askAiBtn.disabled = false, 3000);
            }
        });
    }

    window.onload = scrollToBottom;
</script>
{% endblock %}